<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Escanea QR y C√≥digos de Barras</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #f5f5f5;
      overflow-x: hidden;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      font-size: 1.5em;
    }
    select, button, textarea, input[type="file"] {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    textarea {
      height: 80px;
      resize: vertical;
      font-family: Arial, sans-serif;
    }
    button {
      background-color: #007cba;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #005a87;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .warning { background-color: #fff3cd; color: #856404; }
    .info { background-color: #d1ecf1; color: #0c5460; }
    #result {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border-left: 4px solid #007cba;
    }
    #qrData {
      word-break: break-all;
      background: white;
      padding: 10px;
      border-radius: 3px;
      border: 1px solid #ddd;
    }
    .hidden {
      display: none;
    }
    .scanner-type {
      margin: 15px 0;
      text-align: center;
    }
    .scanner-type label {
      margin: 0 10px;
      cursor: pointer;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .scanner-options {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .scanner-options label {
      display: block;
      margin: 5px 0;
    }
    .camera-container {
      position: relative;
      width: 100%;
      margin: 10px 0;
      overflow: hidden;
      border-radius: 5px;
      background-color: #000;
    }
    #reader {
      width: 100%;
      height: 300px;
      border-radius: 5px;
      margin: 10px 0;
      background: #000;
    }
    #video {
      width: 100%;
      height: auto;
      display: none;
      object-fit: cover;
    }
    #canvas {
      display: none;
    }
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    .scan-region {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      max-width: 250px;
      height: 0;
      padding-bottom: 70%;
      max-height: 250px;
      border: 2px solid rgba(0, 124, 186, 0.8);
      border-radius: 10px;
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, transparent, #ff3b30, transparent);
      animation: scanLine 2s linear infinite;
    }
    .corner {
      position: absolute;
      width: 20px;
      height: 20px;
      border: 3px solid #ff3b30;
    }
    .corner-tl {
      top: -2px;
      left: -2px;
      border-right: none;
      border-bottom: none;
    }
    .corner-tr {
      top: -2px;
      right: -2px;
      border-left: none;
      border-bottom: none;
    }
    .corner-bl {
      bottom: -2px;
      left: -2px;
      border-right: none;
      border-top: none;
    }
    .corner-br {
      bottom: -2px;
      right: -2px;
      border-left: none;
      border-top: none;
    }
    .scan-feedback {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      border-radius: 5px;
      text-align: center;
      font-size: 14px;
    }
    .debug-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px;
      border-radius: 5px;
      text-align: center;
      font-size: 12px;
    }
    .redirect-message {
      margin-top: 15px;
      padding: 10px;
      background-color: #e7f3ff;
      border-radius: 5px;
      text-align: center;
      font-size: 14px;
      color: #0066cc;
    }
    .countdown {
      font-weight: bold;
      color: #ff6600;
    }
    .barcode-options {
      background-color: #f0f8ff;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .barcode-options label {
      display: block;
      margin: 5px 0;
    }
    .file-upload {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border: 2px dashed #ddd;
      text-align: center;
    }
    .file-upload:hover {
      border-color: #007cba;
      background-color: #f0f8ff;
    }
    @keyframes scanLine {
      0% { top: 0; }
      100% { top: 100%; }
    }
  </style>
  <!-- Librer√≠a que funciona para QR -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <!-- Librer√≠a para c√≥digos de barras -->
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <!-- Librer√≠a ZXing como alternativa -->
  <script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Escanea QR y C√≥digos de Barras</h1>

    <!-- SELECT DE USUARIO -->
    <div class="form-group">
      <label for="userSelect">Usuario:</label>
      <select id="userSelect" required>
        <option value="">Selecciona tu nombre</option>
        <option value="Ana">Ana</option>
        <option value="Juan">Juan</option>
        <option value="Luis">Luis</option>
        <option value="Mar√≠a">Mar√≠a</option>
        <option value="Pedro">Pedro</option>
      </select>
    </div>

    <!-- SELECT DE PROYECTO -->
    <div class="form-group">
      <label for="projectSelect">Proyecto:</label>
      <select id="projectSelect" required>
        <option value="">Selecciona el Proyecto</option>
        <option value="Hyatt">Hyatt</option>
        <option value="MAriott">MAriott</option>
        <option value="Hilton">Hilton</option>
        <option value="Magestic">Magestic</option>
        <option value="Otros">Otros</option>
      </select>
    </div>

    <!-- CAMPO DE COMENTARIOS -->
    <div class="form-group">
      <label for="comments">Comentarios (opcional):</label>
      <textarea id="comments" placeholder="Escribe aqu√≠ cualquier comentario adicional..."></textarea>
    </div>

    <!-- TIPO DE ESC√ÅNER -->
    <div class="scanner-type">
      <strong>Tipo de esc√°ner:</strong>
      <label><input type="radio" name="scannerType" value="both" checked> Ambos (QR + C√≥digos de Barras)</label>
      <label><input type="radio" name="scannerType" value="qr"> Solo QR</label>
      <label><input type="radio" name="scannerType" value="barcode"> Solo C√≥digos de Barras</label>
    </div>

    <!-- OPCIONES AVANZADAS DE ESC√ÅNEO QR -->
    <div class="scanner-options">
      <strong>Opciones avanzadas de escaneo QR:</strong>
      <label><input type="checkbox" id="invertColors" checked> Detectar QRs invertidos</label>
      <label><input type="checkbox" id="enhanceContrast"> Mejorar contraste</label>
      <label><input type="checkbox" id="debugMode"> Modo depuraci√≥n</label>
    </div>

    <!-- OPCIONES AVANZADAS DE ESC√ÅNEO DE C√ìDIGOS DE BARRAS -->
    <div class="barcode-options">
      <strong>Opciones avanzadas de c√≥digos de barras:</strong>
      <label><input type="checkbox" id="barcodeMultiLibrary" checked> M√∫ltiples librer√≠as (Quagga + ZXing)</label>
      <label><input type="checkbox" id="barcodeEnhance" checked> Modo de alta precisi√≥n</label>
      <label><input type="checkbox" id="barcodeTryHarder" checked> Intentos m√∫ltiples</label>
      <label><input type="checkbox" id="barcodeDebug"> Modo depuraci√≥n</label>
    </div>

    <!-- OPCI√ìN PARA SUBIR IMAGEN -->
    <div class="file-upload">
      <label for="fileInput">
        <strong>üìÅ O sube una imagen del c√≥digo</strong>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
      </label>
      <p style="margin: 5px 0; font-size: 12px; color: #666;">
        Si la c√°mara no detecta el c√≥digo, prueba subiendo una imagen
      </p>
    </div>

    <!-- C√ÅMARA Y CANVAS -->
    <div id="cameraSection" class="hidden">
      <div class="camera-container">
        <div id="reader"></div>
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        <div class="scanner-overlay">
          <div class="scan-region">
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
            <div class="scan-line"></div>
          </div>
          <div id="scanFeedback" class="scan-feedback hidden">Buscando c√≥digo QR...</div>
          <div id="debugInfo" class="debug-info hidden"></div>
        </div>
      </div>
      
      <div class="buttons">
        <button id="stopScan">Detener Escaneo</button>
      </div>
    </div>

    <!-- BOT√ìN PARA INICIAR -->
    <button id="startScan">Iniciar Escaneo</button>

    <!-- ESTADO -->
    <div id="status"></div>

    <!-- RESULTADO -->
    <div id="result" class="hidden">
      <h3>Datos Escaneados:</h3>
      <p id="qrData"></p>
      <div class="buttons">
        <button id="saveData">Guardar en Google Sheets</button>
        <button id="scanAgain">Escanear otro</button>
      </div>
      <div id="redirectMessage" class="redirect-message hidden">
        Ser√°s redirigido al formulario en <span id="countdown" class="countdown">5</span> segundos...
      </div>
    </div>
  </div>

  <script>
    // URL fija de Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGNCa7bR07OAsHxewLVXLkcJV6k8G4zJEUCYkxYyg36W_18T9jjfRwddbvmB9oTeoI/exec';
    
    // URL del formulario de Google para redirecci√≥n
    const GOOGLE_FORM_URL = 'https://forms.gle/HJGdSzr79Mf79ibH6';

    // Elementos DOM
    const userSelect = document.getElementById('userSelect');
    const projectSelect = document.getElementById('projectSelect');
    const commentsInput = document.getElementById('comments');
    const startScanBtn = document.getElementById('startScan');
    const stopScanBtn = document.getElementById('stopScan');
    const saveDataBtn = document.getElementById('saveData');
    const scanAgainBtn = document.getElementById('scanAgain');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const canvasContext = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const qrDataDiv = document.getElementById('qrData');
    const cameraSection = document.getElementById('cameraSection');
    const scannerTypeRadios = document.querySelectorAll('input[name="scannerType"]');
    const scanFeedback = document.getElementById('scanFeedback');
    const debugInfo = document.getElementById('debugInfo');
    const redirectMessage = document.getElementById('redirectMessage');
    const countdownSpan = document.getElementById('countdown');
    const fileInput = document.getElementById('fileInput');
    
    // Opciones de escaneo
    const invertColorsCheckbox = document.getElementById('invertColors');
    const enhanceContrastCheckbox = document.getElementById('enhanceContrast');
    const debugModeCheckbox = document.getElementById('debugMode');
    
    // Opciones de c√≥digos de barras
    const barcodeMultiLibraryCheckbox = document.getElementById('barcodeMultiLibrary');
    const barcodeEnhanceCheckbox = document.getElementById('barcodeEnhance');
    const barcodeTryHarderCheckbox = document.getElementById('barcodeTryHarder');
    const barcodeDebugCheckbox = document.getElementById('barcodeDebug');

    let stream = null;
    let scanning = false;
    let currentQRData = '';
    let quaggaInitialized = false;
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 1000; // 1 segundo entre escaneos para evitar duplicados
    let frameCount = 0;
    let html5QrCode = null;
    let redirectTimer = null;
    let zxingCodeReader = null;

    // Funci√≥n para mostrar mensajes de estado
    function showStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = type;
      statusDiv.style.display = 'block';
    }

    // Funci√≥n para ocultar mensajes de estado
    function hideStatus() {
      statusDiv.style.display = 'none';
    }

    // Obtener tipo de esc√°ner seleccionado
    function getScannerType() {
      for (const radio of scannerTypeRadios) {
        if (radio.checked) return radio.value;
      }
      return 'both';
    }

    // Funci√≥n para preprocesar imagen para c√≥digos de barras
    function preprocessImageForBarcode(imageData) {
      const data = imageData.data;
      const width = imageData.width;
      const height = imageData.height;
      
      // Convertir a escala de grises
      for (let i = 0; i < data.length; i += 4) {
        const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
        data[i] = gray;
        data[i + 1] = gray;
        data[i + 2] = gray;
      }
      
      // Mejorar contraste para c√≥digos de barras
      if (barcodeEnhanceCheckbox.checked) {
        // Aplicar m√∫ltiples t√©cnicas de mejora
        
        // 1. Ecualizaci√≥n de histograma
        const histogram = new Array(256).fill(0);
        for (let i = 0; i < data.length; i += 4) {
          histogram[data[i]]++;
        }
        
        // 2. Calcular LUT (Look-Up Table)
        const lut = new Array(256);
        const cdf = new Array(256);
        cdf[0] = histogram[0];
        for (let i = 1; i < 256; i++) {
          cdf[i] = cdf[i-1] + histogram[i];
        }
        
        const cdfMin = cdf.find(val => val > 0);
        const pixelCount = width * height;
        const alpha = 255 / (pixelCount - cdfMin);
        
        for (let i = 0; i < 256; i++) {
          lut[i] = Math.round(((cdf[i] - cdfMin) * alpha));
        }
        
        // 3. Aplicar LUT
        for (let i = 0; i < data.length; i += 4) {
          data[i] = lut[data[i]];
          data[i + 1] = lut[data[i + 1]];
          data[i + 2] = lut[data[i + 2]];
        }
        
        // 4. Aplicar umbral adaptativo
        for (let i = 0; i < data.length; i += 4) {
          const value = data[i];
          // Umbral m√°s agresivo
          const enhanced = value > 120 ? 255 : 0;
          data[i] = enhanced;
          data[i + 1] = enhanced;
          data[i + 2] = enhanced;
        }
      }
      
      return imageData;
    }

    // Funci√≥n para escanear con ZXing
    async function scanWithZXing(imageData) {
      if (!zxingCodeReader) {
        zxingCodeReader = new ZXing.BrowserMultiFormatReader();
      }
      
      try {
        // Crear un canvas temporal
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = imageData.width;
        tempCanvas.height = imageData.height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.putImageData(imageData, 0, 0);
        
        // Crear luminance source
        const luminanceSource = new ZXing.HTMLCanvasElementLuminanceSource(tempCanvas);
        const binaryBitmap = new ZXing.BinaryBitmap(new ZXing.HybridBinarizer(luminanceSource));
        
        // Configurar hints
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.TRY_HARDER, barcodeTryHarderCheckbox.checked);
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
          ZXing.BarcodeFormat.CODE_128,
          ZXing.BarcodeFormat.CODE_39,
          ZXing.BarcodeFormat.EAN_13,
          ZXing.BarcodeFormat.EAN_8,
          ZXing.BarcodeFormat.UPC_A,
          ZXing.BarcodeFormat.UPC_E,
          ZXing.BarcodeFormat.CODE_93,
          ZXing.BarcodeFormat.ITF,
          ZXing.BarcodeFormat.CODABAR
        ]);
        
        // Intentar decodificar
        const result = await zxingCodeReader.decodeBitmap(binaryBitmap, hints);
        return result ? result.text : null;
      } catch (err) {
        if (barcodeDebugCheckbox.checked) {
          console.log('ZXing error:', err.message);
        }
        return null;
      }
    }

    // Funci√≥n para escanear c√≥digos de barras con m√∫ltiples librer√≠as
    async function scanBarcodeWithMultipleLibraries() {
      if (!scanning || getScannerType() === 'qr' || !video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
      
      frameCount++;
      
      try {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
        const processedImageData = preprocessImageForBarcode(imageData);
        
        // Mostrar informaci√≥n de depuraci√≥n
        if (barcodeDebugCheckbox.checked && frameCount % 30 === 0) {
          debugInfo.textContent = `Frame ${frameCount}: Probando m√∫ltiples librer√≠as...`;
        }
        
        let result = null;
        
        // 1. Intentar con ZXing si est√° activado
        if (barcodeMultiLibraryCheckbox.checked) {
          result = await scanWithZXing(processedImageData);
          if (result) {
            if (barcodeDebugCheckbox.checked) {
              debugInfo.textContent = `ZXing detect√≥: ${result}`;
            }
            handleScannedCode(result, 'C√≥digo de barras');
            return;
          }
        }
        
        // 2. Intentar con html5-qrcode desde canvas
        if (html5QrCode && html5QrCode.isScanning) {
          try {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = processedImageData.width;
            tempCanvas.height = processedImageData.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(processedImageData, 0, 0);
            
            const img = new Image();
            img.onload = function() {
              Html5Qrcode.scanFile(img, true)
                .then(decodedText => {
                  if (decodedText && getScannerType() !== 'qr') {
                    if (barcodeDebugCheckbox.checked) {
                      debugInfo.textContent = `html5-qrcode detect√≥: ${decodedText}`;
                    }
                    handleScannedCode(decodedText, 'C√≥digo de barras');
                  }
                })
                .catch(err => {
                  // Silenciar errores
                });
            };
            img.src = tempCanvas.toDataURL();
          } catch (err) {
            // Silenciar errores
          }
        }
        
      } catch (err) {
        if (barcodeDebugCheckbox.checked) {
          debugInfo.textContent = `Error: ${err.message}`;
        }
      }
    }

    // Funci√≥n para escanear imagen subida
    async function scanUploadedFile(file) {
      showStatus('Procesando imagen...', 'info');
      
      try {
        // Crear un ImageReader
        const reader = new FileReader();
        reader.onload = async function(e) {
          const img = new Image();
          img.onload = async function() {
            canvas.width = img.width;
            canvas.height = img.height;
            canvasContext.drawImage(img, 0, 0);
            
            const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
            const processedImageData = preprocessImageForBarcode(imageData);
            
            // Intentar con html5-qrcode primero
            try {
              const result = await Html5Qrcode.scanFile(file, true);
              if (result) {
                const type = result.format.formatName.includes('QR') ? 'QR' : 'C√≥digo de barras';
                handleScannedCode(result, type);
                return;
              }
            } catch (err) {
              console.log('html5-qrcode no detect√≥:', err);
            }
            
            // Intentar con ZXing
            if (barcodeMultiLibraryCheckbox.checked) {
              const zxingResult = await scanWithZXing(processedImageData);
              if (zxingResult) {
                handleScannedCode(zxingResult, 'C√≥digo de barras');
                return;
              }
            }
            
            showStatus('No se pudo detectar ning√∫n c√≥digo en la imagen', 'warning');
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      } catch (err) {
        showStatus('Error al procesar la imagen: ' + err.message, 'error');
      }
    }

    // Inicializar Quagga para c√≥digos de barras
    function initQuagga() {
      if (quaggaInitialized) return;
      
      const config = {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: video,
          constraints: {
            facingMode: "environment",
            width: { min: 640, ideal: 1280 },
            height: { min: 480, ideal: 720 }
          }
        },
        locator: {
          patchSize: barcodeEnhanceCheckbox.checked ? "x-large" : "large",
          halfSample: false,
          debug: {
            showCanvas: barcodeDebugCheckbox.checked,
            showPatches: barcodeDebugCheckbox.checked,
            showFoundPatches: barcodeDebugCheckbox.checked,
            showSkeleton: barcodeDebugCheckbox.checked,
            showLabels: barcodeDebugCheckbox.checked,
            showPatchLabels: barcodeDebugCheckbox.checked,
            showRemainingPatchLabels: barcodeDebugCheckbox.checked,
            boxFromPatches: {
              showTransformed: barcodeDebugCheckbox.checked,
              showTransformedBox: barcodeDebugCheckbox.checked,
              showBB: barcodeDebugCheckbox.checked
            }
          }
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        frequency: barcodeTryHarderCheckbox.checked ? 2 : 5,
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_39_vin_reader",
            "codabar_reader",
            "upc_reader",
            "upc_e_reader",
            "i2of5_reader",
            "2of5_reader",
            "code_93_reader",
            "code_32_reader"
          ],
          debug: {
            drawBoundingBox: barcodeDebugCheckbox.checked,
            showFrequency: barcodeDebugCheckbox.checked,
            drawScanline: barcodeDebugCheckbox.checked,
            showPattern: barcodeDebugCheckbox.checked
          }
        },
        locate: true
      };
      
      Quagga.init(config, function(err) {
        if (err) {
          console.log('Quagga initialization error:', err);
          return;
        }
        quaggaInitialized = true;
        Quagga.start();
        
        // Iniciar escaneo adicional si est√° activado
        if (barcodeMultiLibraryCheckbox.checked || barcodeEnhanceCheckbox.checked) {
          setInterval(scanBarcodeWithMultipleLibraries, 400);
        }
      });

      Quagga.onProcessed(function(result) {
        if (barcodeDebugCheckbox.checked && result) {
          const drawingCtx = Quagga.canvas.ctx.overlay;
          const canvas = Quagga.canvas.dom.overlay;
          
          if (result.boxes) {
            drawingCtx.clearRect(0, 0, canvas.width, canvas.height);
            result.boxes.filter(function (box) {
              return box !== result.box;
            }).forEach(function (box) {
              Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
            });
          }
          
          if (result.box) {
            Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "blue", lineWidth: 2});
          }
          
          if (result.codeResult && result.codeResult.code) {
            Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
          }
        }
      });

      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        if (code && getScannerType() !== 'qr') {
          if (barcodeDebugCheckbox.checked) {
            debugInfo.textContent = `Quagga detect√≥: ${code}`;
          }
          handleScannedCode(code, 'C√≥digo de barras');
        }
      });
    }

    // Detener Quagga
    function stopQuagga() {
      if (quaggaInitialized) {
        Quagga.stop();
        quaggaInitialized = false;
        
        const debugCanvas = Quagga.canvas.dom.overlay;
        if (debugCanvas && debugCanvas.parentNode) {
          debugCanvas.parentNode.removeChild(debugCanvas);
        }
      }
    }

    // Funci√≥n para manejar c√≥digo escaneado
    function handleScannedCode(code, type) {
      const now = Date.now();
      if (now - lastScanTime < SCAN_COOLDOWN) {
        return;
      }
      
      lastScanTime = now;
      currentQRData = code;
      showQRResult(currentQRData, type);
      stopCamera();
    }

    // Funci√≥n para iniciar la c√°mara
    async function startCamera() {
      if (!userSelect.value) {
        showStatus('Por favor selecciona un usuario', 'error');
        return;
      }
      
      if (!projectSelect.value) {
        showStatus('Por favor selecciona un proyecto', 'error');
        return;
      }

      try {
        showStatus('Iniciando c√°mara...', 'info');
        
        cameraSection.classList.remove('hidden');
        startScanBtn.classList.add('hidden');
        scanning = true;
        
        hideStatus();
        scanFeedback.classList.remove('hidden');
        
        if (debugModeCheckbox.checked || barcodeDebugCheckbox.checked) {
          debugInfo.classList.remove('hidden');
        }
        
        const scannerType = getScannerType();
        
        if (scannerType !== 'barcode') {
          html5QrCode = new Html5Qrcode("reader");
          
          const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            experimentalFeatures: {
              useBarCodeDetectorIfSupported: true
            }
          };
          
          await html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText, decodedResult) => {
              const format = decodedResult.result.format.formatName;
              const type = format.includes('QR') ? 'QR' : 'C√≥digo de barras';
              
              if (debugModeCheckbox.checked) {
                debugInfo.textContent = `${type} detectado: ${decodedText.substring(0, 20)}...`;
              }
              
              if (type === 'QR' && getScannerType() !== 'barcode') {
                handleScannedCode(decodedText, 'QR');
              } else if (type === 'C√≥digo de barras' && getScannerType() !== 'qr') {
                handleScannedCode(decodedText, 'C√≥digo de barras');
              }
            },
            (errorMessage) => {
              if (debugModeCheckbox.checked && frameCount % 30 === 0) {
                debugInfo.textContent = `Error: ${errorMessage}`;
              }
            }
          ).then(() => {
            scanFeedback.textContent = "üéØ Apunta al c√≥digo con la c√°mara";
          }).catch(err => {
            showStatus(`Error al iniciar esc√°ner: ${err}`, 'error');
            console.error("Error al iniciar html5-qrcode:", err);
          });
        }
        
        if (scannerType !== 'qr') {
          video.style.display = 'block';
          scanFeedback.textContent = "üéØ Apunta al c√≥digo de barras con la c√°mara";
          initQuagga();
        }
        
      } catch (error) {
        showStatus('Error al acceder a la c√°mara: ' + error.message, 'error');
        console.error("Error al iniciar c√°mara:", error);
      }
    }

    // Funci√≥n para detener la c√°mara
    function stopCamera() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode = null;
        }).catch(err => {
          console.error("Error al detener html5-qrcode:", err);
        });
      }
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      scanning = false;
      cameraSection.classList.add('hidden');
      startScanBtn.classList.remove('hidden');
      scanFeedback.classList.add('hidden');
      debugInfo.classList.add('hidden');
      video.style.display = 'none';
      hideStatus();
      stopQuagga();
    }

    // Funci√≥n para mostrar resultado del QR
    function showQRResult(data, type) {
      qrDataDiv.innerHTML = `<strong>Tipo:</strong> ${type}<br><strong>Datos:</strong> ${data}`;
      resultDiv.classList.remove('hidden');
      showStatus(`${type} detectado correctamente`, 'success');
      
      if (navigator.vibrate) navigator.vibrate(200);
    }

    // Funci√≥n para redirigir al formulario de Google
    function redirectToGoogleForm() {
      redirectMessage.classList.remove('hidden');
      let countdown = 5;
      countdownSpan.textContent = countdown;
      
      redirectTimer = setInterval(() => {
        countdown--;
        countdownSpan.textContent = countdown;
        
        if (countdown <= 0) {
          clearInterval(redirectTimer);
          window.location.href = GOOGLE_FORM_URL;
        }
      }, 1000);
    }

    // Funci√≥n para guardar datos en Google Sheets
    async function saveToGoogleSheets() {
      const user = userSelect.value;
      const project = projectSelect.value;
      const qrData = currentQRData;
      const comments = commentsInput.value.trim();

      if (!user) {
        showStatus('Por favor selecciona un usuario', 'error');
        return;
      }
      
      if (!project) {
        showStatus('Por favor selecciona un proyecto', 'error');
        return;
      }
      
      if (!qrData) {
        showStatus('No hay datos para guardar', 'error');
        return;
      }

      saveDataBtn.disabled = true;
      showStatus('Guardando datos...', 'info');

      try {
        const formData = new URLSearchParams();
        formData.append('user', user);
        formData.append('project', project);
        formData.append('qrData', qrData);
        formData.append('comments', comments);

        console.log('Enviando datos a:', SCRIPT_URL);
        console.log('Datos:', { user, project, qrData, comments });

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
          },
          body: formData.toString()
        });

        console.log('Respuesta recibida, status:', response.status);

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
        }

        const result = await response.text();
        console.log('Resultado:', result);

        if (result.includes('√âXITO')) {
          showStatus('‚úì Datos guardados exitosamente en Google Sheets', 'success');
          redirectToGoogleForm();
        } else if (result.includes('DUPLICADO')) {
          showStatus('‚ö† Este c√≥digo ya fue escaneado anteriormente', 'warning');
          saveDataBtn.disabled = false;
        } else {
          showStatus('‚úó Error al guardar: ' + result, 'error');
          saveDataBtn.disabled = false;
        }
      } catch (error) {
        console.error('Error completo:', error);
        showStatus('‚úó Error de conexi√≥n: ' + error.message, 'error');
        saveDataBtn.disabled = false;
      }
    }

    // Event Listeners
    startScanBtn.addEventListener('click', startCamera);
    stopScanBtn.addEventListener('click', stopCamera);
    saveDataBtn.addEventListener('click', saveToGoogleSheets);
    
    scanAgainBtn.addEventListener('click', function() {
      if (redirectTimer) {
        clearInterval(redirectTimer);
        redirectTimer = null;
      }
      
      resultDiv.classList.add('hidden');
      redirectMessage.classList.add('hidden');
      currentQRData = '';
      hideStatus();
      startCamera();
    });

    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        scanUploadedFile(file);
      }
    });

    userSelect.addEventListener('change', hideStatus);
    projectSelect.addEventListener('change', hideStatus);

    debugModeCheckbox.addEventListener('change', function() {
      if (this.checked && scanning) {
        debugInfo.classList.remove('hidden');
      } else {
        debugInfo.classList.add('hidden');
      }
    });
    
    barcodeDebugCheckbox.addEventListener('change', function() {
      if (this.checked && scanning && getScannerType() !== 'qr') {
        debugInfo.classList.remove('hidden');
        if (quaggaInitialized) {
          stopQuagga();
          initQuagga();
        }
      } else {
        debugInfo.classList.add('hidden');
        if (quaggaInitialized) {
          stopQuagga();
          initQuagga();
        }
      }
    });
    
    barcodeMultiLibraryCheckbox.addEventListener('change', function() {
      if (quaggaInitialized) {
        stopQuagga();
        initQuagga();
      }
    });
    
    barcodeEnhanceCheckbox.addEventListener('change', function() {
      if (quaggaInitialized) {
        stopQuagga();
        initQuagga();
      }
    });
    
    barcodeTryHarderCheckbox.addEventListener('change', function() {
      if (quaggaInitialized) {
        stopQuagga();
        initQuagga();
      }
    });
  </script>
</body>
</html>
