<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escanea QR y C√≥digos de Barras - Mejorado</title>
  <style>
    /* Tus estilos actuales se mantienen igual */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    /* ... (mant√©n todos tus estilos existentes) ... */
    
    /* Nuevos estilos para mejoras visuales */
    .scanning-area {
      position: relative;
      width: 100%;
      margin: 10px 0;
    }
    .scan-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: 200px;
      border: 3px solid #007cba;
      border-radius: 10px;
      pointer-events: none;
      z-index: 10;
    }
    .scan-frame::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 8px;
    }
    .quality-indicator {
      margin: 10px 0;
      padding: 8px;
      border-radius: 5px;
      text-align: center;
      font-size: 14px;
    }
    .debug-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>Escanea C√≥digos QR/Barras del LCU</h1>

    <!-- Tus selects y controles se mantienen igual -->
    <div class="form-group">
      <label for="userSelect">Usuario:</label>
      <select id="userSelect" required>
        <option value="">Selecciona tu nombre</option>
        <option value="Angel Perez">Angel Perez</option>
        <option value="Alexander De Dios">Alexander De Dios</option>
        <option value="Victor De la Rosa">Victor De la Rosa</option>
        <option value="Maximo Vallejo">Maximo Vallejo</option>
        <option value="Rosaura Nivar">Rosaura Nivar</option>
        <option value="Alejandro Plasencia">Alejandro Plasencia</option>
      </select>
    </div>

    <div class="form-group">
      <label for="projectSelect">Proyecto:</label>
      <select id="projectSelect" required>
        <option value="">Selecciona el Proyecto</option>
        <option value="Hyatt">Hyatt</option>
        <option value="Mariott">MAriott</option>
        <option value="Hilton">Hilton</option>
        <option value="Magestic">Magestic</option>
        <option value="Otros">Otros</option>
      </select>
    </div>

    <div class="form-group">
      <label for="comments">Comentarios (opcional):</label>
      <textarea id="comments" placeholder="Escribe aqu√≠ cualquier comentario adicional..."></textarea>
    </div>

    <!-- Selector de calidad de c√°mara -->
    <div class="form-group">
      <label for="cameraQuality">Calidad de c√°mara:</label>
      <select id="cameraQuality">
        <option value="environment">Autom√°tica (Recomendada)</option>
        <option value="user">Frontal</option>
        <option value="high">Alta resoluci√≥n</option>
        <option value="medium">Resoluci√≥n media</option>
      </select>
    </div>

    <div class="scanner-type">
      <strong>Tipo de esc√°ner:</strong>
      <label><input type="radio" name="scannerType" value="both" checked> Ambos (QR + C√≥digos de Barras)</label>
      <label><input type="radio" name="scannerType" value="qr"> Solo QR</label>
      <label><input type="radio" name="scannerType" value="barcode"> Solo C√≥digos de Barras</label>
    </div>

    <!-- √Årea de escaneo mejorada -->
    <div id="cameraSection" class="hidden">
      <div class="scanning-area">
        <video id="video" autoplay playsinline></video>
        <div class="scan-frame"></div>
        <div id="scannerOverlay" style="position: relative; margin-top: 10px;">
          <div style="width: 100%; height: 2px; background: red; position: absolute; top: 50%; animation: scanLine 2s linear infinite;"></div>
        </div>
      </div>
      
      <div id="qualityInfo" class="quality-indicator hidden"></div>
      
      <canvas id="canvas" class="hidden"></canvas>
      
      <div class="buttons">
        <button id="stopScan">Detener Escaneo</button>
        <button id="toggleTorch" class="hidden">üî¶ Encender Linterna</button>
      </div>
    </div>

    <button id="startScan">Iniciar Escaneo</button>

    <div id="status"></div>

    <div id="result" class="hidden">
      <h3>Datos Escaneados:</h3>
      <p id="qrData"></p>
      <div class="debug-info" id="debugInfo"></div>
      <div class="buttons">
        <button id="saveData">Guardarlo en BD</button>
        <button id="scanAgain">Escanear otro</button>
      </div>
    </div>
  </div>

  <div style="text-align: center; margin-top: 20px;">
    <a href="reportes.html" style="color: #007cba; text-decoration: none; font-weight: bold;">
      üìä Ver Reportes y Estad√≠sticas
    </a>
  </div>

  <script>
    // URL fija de Google Apps Script
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGNCa7bR07OAsHxewLVXLkcJV6k8G4zJEUCYkxYyg36W_18T9jjfRwddbvmB9oTeoI/exec';

    // Elementos DOM
    const userSelect = document.getElementById('userSelect');
    const projectSelect = document.getElementById('projectSelect');
    const commentsInput = document.getElementById('comments');
    const cameraQualitySelect = document.getElementById('cameraQuality');
    const startScanBtn = document.getElementById('startScan');
    const stopScanBtn = document.getElementById('stopScan');
    const saveDataBtn = document.getElementById('saveData');
    const scanAgainBtn = document.getElementById('scanAgain');
    const toggleTorchBtn = document.getElementById('toggleTorch');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const canvasContext = canvas.getContext('2d', { willReadFrequently: true });
    const statusDiv = document.getElementById('status');
    const resultDiv = document.getElementById('result');
    const qrDataDiv = document.getElementById('qrData');
    const debugInfoDiv = document.getElementById('debugInfo');
    const cameraSection = document.getElementById('cameraSection');
    const qualityInfoDiv = document.getElementById('qualityInfo');
    const scannerTypeRadios = document.querySelectorAll('input[name="scannerType"]');

    let stream = null;
    let scanning = false;
    let currentQRData = '';
    let quaggaInitialized = false;
    let torchOn = false;
    let scanAttempts = 0;
    let lastScannedCode = '';

    // Configuraci√≥n mejorada de Quagga
    const quaggaConfig = {
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: video,
        constraints: {
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 },
          aspectRatio: { ideal: 1.333 }
        }
      },
      locator: {
        patchSize: "medium",
        halfSample: true
      },
      numOfWorkers: 2,
      decoder: {
        readers: [
          "code_128_reader",
          "ean_reader",
          "ean_8_reader",
          "code_39_reader",
          "code_39_vin_reader",
          "codabar_reader",
          "upc_reader",
          "upc_e_reader",
          "i2of5_reader"
        ]
      },
      locate: true,
      frequency: 10
    };

    // Funci√≥n para mostrar mensajes de estado
    function showStatus(message, type = 'info') {
      statusDiv.textContent = message;
      statusDiv.className = type;
      statusDiv.style.display = 'block';
    }

    function hideStatus() {
      statusDiv.style.display = 'none';
    }

    // Obtener tipo de esc√°ner seleccionado
    function getScannerType() {
      for (const radio of scannerTypeRadios) {
        if (radio.checked) return radio.value;
      }
      return 'both';
    }

    // Configuraci√≥n mejorada de c√°mara
    function getCameraConstraints() {
      const quality = cameraQualitySelect.value;
      
      switch(quality) {
        case 'high':
          return {
            video: { 
              facingMode: "environment",
              width: { ideal: 1920 },
              height: { ideal: 1080 },
              frameRate: { ideal: 30 }
            }
          };
        case 'medium':
          return {
            video: { 
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
              frameRate: { ideal: 30 }
            }
          };
        case 'user':
          return {
            video: { 
              facingMode: "user",
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          };
        default:
          return {
            video: { 
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }
          };
      }
    }

    // Control de linterna (solo en dispositivos compatibles)
    async function toggleTorch() {
      if (!stream) return;
      
      const track = stream.getVideoTracks()[0];
      if (!track || !track.getCapabilities().torch) {
        showStatus('Linterna no disponible en este dispositivo', 'warning');
        return;
      }

      try {
        await track.applyConstraints({
          advanced: [{ torch: !torchOn }]
        });
        torchOn = !torchOn;
        toggleTorchBtn.textContent = torchOn ? 'üî¶ Apagar Linterna' : 'üî¶ Encender Linterna';
        showStatus(torchOn ? 'Linterna encendida' : 'Linterna apagada', 'info');
      } catch (error) {
        console.error('Error al controlar linterna:', error);
        showStatus('Error al controlar linterna', 'error');
      }
    }

    // Inicializaci√≥n mejorada de Quagga
    function initQuagga() {
      if (quaggaInitialized) return;
      
      return new Promise((resolve, reject) => {
        Quagga.init(quaggaConfig, function(err) {
          if (err) {
            console.error('Quagga initialization error:', err);
            showStatus('Error inicializando esc√°ner de c√≥digos de barras', 'error');
            reject(err);
            return;
          }
          quaggaInitialized = true;
          Quagga.start();
          
          // Mejorar la detecci√≥n con post-procesamiento
          Quagga.onProcessed(function(result) {
            if (result) {
              const ctx = Quagga.canvas.ctx.overlay;
              const canvas = Quagga.canvas.dom.overlay;
              
              if (result.codeResult && result.codeResult.code) {
                drawBarcodeBox(result, ctx, canvas);
              }
            }
          });

          Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            if (code && getScannerType() !== 'qr') {
              // Evitar duplicados consecutivos
              if (code !== lastScannedCode) {
                lastScannedCode = code;
                handleScannedCode(code, 'C√≥digo de barras');
              }
            }
          });
          
          resolve();
        });
      });
    }

    // Dibujar caja alrededor del c√≥digo de barras detectado
    function drawBarcodeBox(result, ctx, canvas) {
      const boundingBox = result.box;
      if (!boundingBox) return;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#00ff00';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(boundingBox[0][0], boundingBox[0][1]);
      for (let i = 1; i < boundingBox.length; i++) {
        ctx.lineTo(boundingBox[i][0], boundingBox[i][1]);
      }
      ctx.closePath();
      ctx.stroke();
    }

    // Detener Quagga mejorado
    function stopQuagga() {
      if (quaggaInitialized) {
        try {
          Quagga.offDetected();
          Quagga.offProcessed();
          Quagga.stop();
          quaggaInitialized = false;
        } catch (error) {
          console.error('Error stopping Quagga:', error);
        }
      }
    }

    // Funci√≥n para manejar c√≥digo escaneado
    function handleScannedCode(code, type) {
      currentQRData = code;
      showQRResult(currentQRData, type);
      stopCamera();
    }

    // Funci√≥n mejorada para iniciar la c√°mara
    async function startCamera() {
      if (!userSelect.value) {
        showStatus('Por favor selecciona un usuario', 'error');
        return;
      }
      
      if (!projectSelect.value) {
        showStatus('Por favor selecciona un proyecto', 'error');
        return;
      }

      try {
        showStatus('Iniciando c√°mara...', 'info');
        
        const constraints = getCameraConstraints();
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        
        video.srcObject = stream;
        cameraSection.classList.remove('hidden');
        startScanBtn.classList.add('hidden');
        scanning = true;
        scanAttempts = 0;
        lastScannedCode = '';
        
        // Mostrar informaci√≥n de calidad
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        qualityInfoDiv.textContent = `Resoluci√≥n: ${settings.width}x${settings.height} - FPS: ${settings.frameRate || 'N/A'}`;
        qualityInfoDiv.className = 'quality-indicator info';
        
        hideStatus();

        // Inicializar esc√°ner seg√∫n el tipo seleccionado
        const scannerType = getScannerType();
        if (scannerType !== 'barcode') {
          scanQRCode();
        }
        if (scannerType !== 'qr') {
          await initQuagga();
        }
        
        // Mostrar bot√≥n de linterna si est√° disponible
        if (track.getCapabilities().torch) {
          toggleTorchBtn.classList.remove('hidden');
        }
        
      } catch (error) {
        console.error('Camera error:', error);
        showStatus('Error al acceder a la c√°mara: ' + error.message, 'error');
        
        // Fallback a configuraci√≥n b√°sica
        if (error.name === 'OverconstrainedError') {
          showStatus('Intentando con configuraci√≥n b√°sica...', 'warning');
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            cameraSection.classList.remove('hidden');
            startScanBtn.classList.add('hidden');
            scanning = true;
            scanQRCode();
          } catch (fallbackError) {
            showStatus('No se pudo acceder a la c√°mara: ' + fallbackError.message, 'error');
          }
        }
      }
    }

    // Funci√≥n para detener la c√°mara
    function stopCamera() {
      scanning = false;
      
      if (stream) {
        stream.getTracks().forEach(track => {
          track.stop();
        });
        stream = null;
      }
      
      cameraSection.classList.add('hidden');
      startScanBtn.classList.remove('hidden');
      toggleTorchBtn.classList.add('hidden');
      qualityInfoDiv.classList.add('hidden');
      hideStatus();
      stopQuagga();
      torchOn = false;
    }

    // Funci√≥n mejorada para escanear QR
    function scanQRCode() {
      if (!scanning) return;

      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });
        
        if (code && getScannerType() !== 'barcode') {
          // Evitar duplicados consecutivos
          if (code.data !== lastScannedCode) {
            lastScannedCode = code.data;
            handleScannedCode(code.data, 'QR');
          }
        } else {
          scanAttempts++;
          // Cada 50 intentos, mostrar informaci√≥n de diagn√≥stico
          if (scanAttempts % 50 === 0) {
            debugInfoDiv.textContent = `Intentos de escaneo: ${scanAttempts} - Tama√±o imagen: ${canvas.width}x${canvas.height}`;
          }
        }
      }
      
      if (scanning) {
        requestAnimationFrame(scanQRCode);
      }
    }

    // Funci√≥n para mostrar resultado del QR
    function showQRResult(data, type) {
      qrDataDiv.innerHTML = `<strong>Tipo:</strong> ${type}<br><strong>Datos:</strong> ${data}`;
      debugInfoDiv.textContent = `Escaneado exitoso en ${scanAttempts} intentos`;
      resultDiv.classList.remove('hidden');
      showStatus(`${type} detectado correctamente`, 'success');
    }

    // Funci√≥n para guardar datos en Google Sheets (sin cambios)
    async function saveToGoogleSheets() {
      const user = userSelect.value;
      const project = projectSelect.value;
      const qrData = currentQRData;
      const comments = commentsInput.value.trim();

      if (!user) {
        showStatus('Por favor selecciona un usuario', 'error');
        return;
      }
      
      if (!project) {
        showStatus('Por favor selecciona un proyecto', 'error');
        return;
      }
      
      if (!qrData) {
        showStatus('No hay datos para guardar', 'error');
        return;
      }

      saveDataBtn.disabled = true;
      showStatus('Guardando datos...', 'info');

      try {
        const formData = new URLSearchParams();
        formData.append('user', user);
        formData.append('project', project);
        formData.append('qrData', qrData);
        formData.append('comments', comments);

        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
          },
          body: formData.toString()
        });

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
        }

        const result = await response.text();

        if (result.includes('√âXITO')) {
          showStatus('‚úì Datos guardados exitosamente en Google Sheets', 'success');
          
          setTimeout(() => {
            resultDiv.classList.add('hidden');
            currentQRData = '';
            commentsInput.value = '';
          }, 3000);
          
        } else if (result.includes('DUPLICADO')) {
          showStatus('‚ö† Este c√≥digo ya fue escaneado anteriormente', 'warning');
        } else {
          showStatus('‚úó Error al guardar: ' + result, 'error');
        }
      } catch (error) {
        console.error('Error completo:', error);
        showStatus('‚úó Error de conexi√≥n: ' + error.message, 'error');
      } finally {
        saveDataBtn.disabled = false;
      }
    }

    // Event Listeners
    startScanBtn.addEventListener('click', startCamera);
    stopScanBtn.addEventListener('click', stopCamera);
    saveDataBtn.addEventListener('click', saveToGoogleSheets);
    toggleTorchBtn.addEventListener('click', toggleTorch);
    
    scanAgainBtn.addEventListener('click', function() {
      resultDiv.classList.add('hidden');
      currentQRData = '';
      hideStatus();
      startCamera();
    });

    userSelect.addEventListener('change', hideStatus);
    projectSelect.addEventListener('change', hideStatus);

    // CSS para la animaci√≥n de la l√≠nea de escaneo
    const style = document.createElement('style');
    style.textContent = `
      @keyframes scanLine {
        0% { top: 10%; }
        50% { top: 90%; }
        100% { top: 10%; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
