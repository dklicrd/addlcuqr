<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reportes - Escaneos QR y C√≥digos de Barras</title>
  <style>
    /* CSS B√°sico y Necesario */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .config-section {
      background: #fff3cd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #ffeaa7;
    }
    .filters {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    .filter-item {
      flex: 1;
      min-width: 200px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    select, input, button, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    button {
      background-color: #007cba;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #005a87;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .btn-test {
      background-color: #17a2b8;
    }
    .btn-success {
      background-color: #28a745;
    }
    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }
    .btn-danger {
      background-color: #dc3545;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      text-align: center;
    }
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 5px;
      margin: 20px 0;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #007cba;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">‚Üê Volver al Esc√°ner</a>
    <h1>Reportes de Escaneos</h1>

    <!-- Secci√≥n de Configuraci√≥n -->
    <div class="config-section">
      <h3>üîß Configuraci√≥n de Conexi√≥n</h3>
      <div class="filter-item">
        <label for="scriptUrlInput"><strong>URL de Google Apps Script:</strong></label>
        <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/..." value="https://script.google.com/macros/s/AKfycbzDgU6Q-xRgUgotBXSgXVN0OXEXw4UaSncSIrRkq1rJPgQjfhmxnNhhrHP9RhwTdc5g/exec">
        <small>Obt√©n esta URL desde: Google Apps Script ‚Üí Publicar ‚Üí Implementar como aplicaci√≥n web</small>
      </div>
      <div class="action-buttons">
        <button id="testConnectionBtn" class="btn-test">üîç Probar Conexi√≥n</button>
        <button id="saveUrlBtn" class="btn-success">üíæ Guardar URL</button>
      </div>
      <div id="connectionResult"></div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <h3>üìä Filtros de Reporte</h3>
      <div class="filter-group">
        <div class="filter-item">
          <label for="fechaInicio">Fecha Inicio:</label>
          <input type="date" id="fechaInicio">
        </div>
        <div class="filter-item">
          <label for="fechaFin">Fecha Fin:</label>
          <input type="date" id="fechaFin">
        </div>
        <div class="filter-item">
          <label for="usuarioFiltro">Usuario:</label>
          <select id="usuarioFiltro">
            <option value="">Todos los usuarios</option>
            <option value="Ana">Ana</option>
            <option value="Juan">Juan</option>
            <option value="Luis">Luis</option>
            <option value="Mar√≠a">Mar√≠a</option>
            <option value="Pedro">Pedro</option>
          </select>
        </div>
        <div class="filter-item">
          <label for="proyectoFiltro">Proyecto:</label>
          <select id="proyectoFiltro">
            <option value="">Todos los proyectos</option>
            <option value="Hyatt">Hyatt</option>
            <option value="MAriott">MAriott</option>
            <option value="Hilton">Hilton</option>
            <option value="Magestic">Magestic</option>
            <option value="Otros">Otros</option>
          </select>
        </div>
      </div>
      <div class="action-buttons">
        <button id="btnFiltrar">üîç Aplicar Filtros</button>
        <button id="btnLimpiar" class="btn-warning">üóëÔ∏è Limpiar Filtros</button>
        <button id="btnCargarDatos" class="btn-success">üîÑ Cargar Datos</button>
      </div>
    </div>

    <!-- Mensajes -->
    <div id="errorMessage" class="error-message hidden"></div>
    <div id="successMessage" class="success-message hidden"></div>

    <!-- Resultados -->
    <div class="results">
      <div id="loading" class="loading hidden">
        <p>‚è≥ Cargando datos...</p>
      </div>
      
      <div id="resultados" class="hidden">
        <h3>üìã Resultados</h3>
        <table id="tablaResultados">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Usuario</th>
              <th>QR Data</th>
              <th>Proyecto</th>
              <th>Comentarios</th>
            </tr>
          </thead>
          <tbody id="cuerpoTabla">
          </tbody>
        </table>
        
        <div class="action-buttons">
          <button id="btnExportarExcel" class="btn-success">üìä Exportar a Excel</button>
          <button id="btnExportarPDF" class="btn-warning">üìÑ Exportar a PDF</button>
          <button id="btnEnviarEmail" class="btn-danger">üìß Enviar por Email</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let SCRIPT_URL = '';
    let datosCompletos = [];
    let datosFiltrados = [];

    // Elementos DOM
    const scriptUrlInput = document.getElementById('scriptUrlInput');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const saveUrlBtn = document.getElementById('saveUrlBtn');
    const connectionResult = document.getElementById('connectionResult');
    const fechaInicio = document.getElementById('fechaInicio');
    const fechaFin = document.getElementById('fechaFin');
    const usuarioFiltro = document.getElementById('usuarioFiltro');
    const proyectoFiltro = document.getElementById('proyectoFiltro');
    const btnFiltrar = document.getElementById('btnFiltrar');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const btnCargarDatos = document.getElementById('btnCargarDatos');
    const btnExportarExcel = document.getElementById('btnExportarExcel');
    const btnExportarPDF = document.getElementById('btnExportarPDF');
    const btnEnviarEmail = document.getElementById('btnEnviarEmail');
    const cuerpoTabla = document.getElementById('cuerpoTabla');
    const loading = document.getElementById('loading');
    const resultados = document.getElementById('resultados');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    // Cargar configuraci√≥n guardada
    function cargarConfiguracion() {
      const savedUrl = localStorage.getItem('googleScriptUrl');
      if (savedUrl) {
        scriptUrlInput.value = savedUrl;
        SCRIPT_URL = savedUrl;
        mostrarMensaje('‚úÖ Configuraci√≥n cargada', 'success');
      } else {
        // Usar URL por defecto
        SCRIPT_URL = scriptUrlInput.value;
      }
    }

    // Guardar configuraci√≥n
    function guardarConfiguracion() {
      const url = scriptUrlInput.value.trim();
      if (url) {
        localStorage.setItem('googleScriptUrl', url);
        SCRIPT_URL = url;
        mostrarMensaje('‚úÖ URL guardada correctamente', 'success');
        return true;
      } else {
        mostrarMensaje('‚ùå Por favor ingresa una URL v√°lida', 'error');
        return false;
      }
    }

    // Probar conexi√≥n
    async function probarConexion() {
      if (!guardarConfiguracion()) return;

      connectionResult.innerHTML = '<div style="color: #856404;">üîç Probando conexi√≥n...</div>';
      
      try {
        console.log('Probando conexi√≥n a:', SCRIPT_URL + '?action=getAllData');
        
        const response = await fetch(SCRIPT_URL + '?action=getAllData', {
          method: 'GET',
          mode: 'no-cors' // Intentar sin CORS primero
        }).catch(async () => {
          // Si no-cors falla, intentar con cors
          return await fetch(SCRIPT_URL + '?action=getAllData');
        });

        if (!response || !response.ok) {
          throw new Error('No se pudo conectar al servidor');
        }

        const data = await response.text();
        connectionResult.innerHTML = '<div style="color: #155724;">‚úÖ Conexi√≥n exitosa</div>';
        mostrarMensaje('‚úÖ Conexi√≥n establecida correctamente', 'success');
        
      } catch (error) {
        console.error('Error de conexi√≥n:', error);
        connectionResult.innerHTML = '<div style="color: #721c24;">‚ùå Error de conexi√≥n: ' + error.message + '</div>';
        mostrarMensaje('‚ùå Error de conexi√≥n: ' + error.message, 'error');
      }
    }

    // Cargar datos
    async function cargarDatos() {
      if (!SCRIPT_URL) {
        mostrarMensaje('‚ùå Primero configura la URL', 'error');
        return;
      }

      mostrarLoading(true);
      mostrarMensaje('', 'clear');

      try {
        console.log('Cargando datos desde:', SCRIPT_URL);
        
        const response = await fetch(SCRIPT_URL + '?action=getAllData');
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const text = await response.text();
        console.log('Respuesta recibida:', text.substring(0, 200));

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          throw new Error('El servidor no devolvi√≥ JSON v√°lido');
        }

        if (!Array.isArray(data)) {
          throw new Error('La respuesta no es un array v√°lido');
        }

        datosCompletos = data;
        datosFiltrados = [...datosCompletos];
        
        mostrarMensaje(`‚úÖ ${datosCompletos.length} registros cargados`, 'success');
        actualizarTabla();
        
      } catch (error) {
        console.error('Error cargando datos:', error);
        mostrarMensaje('‚ùå Error cargando datos: ' + error.message, 'error');
        
        // Datos de ejemplo para testing
        datosCompletos = [{
          fecha: new Date().toISOString(),
          usuario: 'Usuario Ejemplo',
          qrData: 'QR_EJEMPLO_001',
          proyecto: 'Proyecto Ejemplo',
          comentarios: 'Datos de ejemplo - Error de conexi√≥n real'
        }];
        datosFiltrados = [...datosCompletos];
        actualizarTabla();
      } finally {
        mostrarLoading(false);
      }
    }

    // Actualizar tabla
    function actualizarTabla() {
      cuerpoTabla.innerHTML = '';
      
      if (datosFiltrados.length === 0) {
        cuerpoTabla.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay datos que coincidan con los filtros</td></tr>';
      } else {
        datosFiltrados.forEach(item => {
          const fila = document.createElement('tr');
          fila.innerHTML = `
            <td>${formatearFecha(item.fecha)}</td>
            <td>${item.usuario}</td>
            <td>${item.qrData}</td>
            <td>${item.proyecto}</td>
            <td>${item.comentarios || ''}</td>
          `;
          cuerpoTabla.appendChild(fila);
        });
      }
      
      resultados.classList.remove('hidden');
    }

    // Aplicar filtros
    function aplicarFiltros() {
      let filtrados = [...datosCompletos];
      
      if (fechaInicio.value) {
        const inicio = new Date(fechaInicio.value);
        filtrados = filtrados.filter(item => new Date(item.fecha) >= inicio);
      }
      
      if (fechaFin.value) {
        const fin = new Date(fechaFin.value);
        fin.setHours(23, 59, 59, 999);
        filtrados = filtrados.filter(item => new Date(item.fecha) <= fin);
      }
      
      if (usuarioFiltro.value) {
        filtrados = filtrados.filter(item => item.usuario === usuarioFiltro.value);
      }
      
      if (proyectoFiltro.value) {
        filtrados = filtrados.filter(item => item.proyecto === proyectoFiltro.value);
      }
      
      datosFiltrados = filtrados;
      actualizarTabla();
      mostrarMensaje(`‚úÖ ${datosFiltrados.length} registros filtrados`, 'success');
    }

    // Limpiar filtros
    function limpiarFiltros() {
      fechaInicio.value = '';
      fechaFin.value = '';
      usuarioFiltro.value = '';
      proyectoFiltro.value = '';
      establecerFechasPorDefecto();
      datosFiltrados = [...datosCompletos];
      actualizarTabla();
      mostrarMensaje('‚úÖ Filtros limpiados', 'success');
    }

    // Utilidades
    function formatearFecha(fechaString) {
      try {
        return new Date(fechaString).toLocaleDateString('es-ES', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        return fechaString;
      }
    }

    function establecerFechasPorDefecto() {
      const hoy = new Date();
      const hace30Dias = new Date();
      hace30Dias.setDate(hoy.getDate() - 30);
      fechaInicio.valueAsDate = hace30Dias;
      fechaFin.valueAsDate = hoy;
    }

    function mostrarLoading(mostrar) {
      loading.classList.toggle('hidden', !mostrar);
    }

    function mostrarMensaje(mensaje, tipo) {
      if (tipo === 'error') {
        errorMessage.textContent = mensaje;
        errorMessage.classList.remove('hidden');
        successMessage.classList.add('hidden');
      } else if (tipo === 'success') {
        successMessage.textContent = mensaje;
        successMessage.classList.remove('hidden');
        errorMessage.classList.add('hidden');
      } else {
        errorMessage.classList.add('hidden');
        successMessage.classList.add('hidden');
      }
    }

    // Exportar funciones
    function exportarAExcel() {
      if (datosFiltrados.length === 0) {
        mostrarMensaje('‚ùå No hay datos para exportar', 'error');
        return;
      }
      
      let csv = "Fecha,Usuario,QR Data,Proyecto,Comentarios\n";
      datosFiltrados.forEach(item => {
        csv += `"${formatearFecha(item.fecha)}","${item.usuario}","${item.qrData}","${item.proyecto}","${item.comentarios || ''}"\n`;
      });
      
      const link = document.createElement('a');
      link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
      link.download = `reporte_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      mostrarMensaje('‚úÖ Datos exportados a CSV', 'success');
    }

    function exportarAPDF() {
      if (datosFiltrados.length === 0) {
        mostrarMensaje('‚ùå No hay datos para exportar', 'error');
        return;
      }
      
      const ventana = window.open('', '_blank');
      ventana.document.write(`
        <html>
          <head><title>Reporte</title></head>
          <body>
            <h1>Reporte de Escaneos</h1>
            <table border="1">${document.getElementById('tablaResultados').innerHTML}</table>
          </body>
        </html>
      `);
      ventana.print();
    }

    // Event Listeners
    testConnectionBtn.addEventListener('click', probarConexion);
    saveUrlBtn.addEventListener('click', guardarConfiguracion);
    btnCargarDatos.addEventListener('click', cargarDatos);
    btnFiltrar.addEventListener('click', aplicarFiltros);
    btnLimpiar.addEventListener('click', limpiarFiltros);
    btnExportarExcel.addEventListener('click', exportarAExcel);
    btnExportarPDF.addEventListener('click', exportarAPDF);
    btnEnviarEmail.addEventListener('click', () => {
      mostrarMensaje('üìß Funci√≥n de email disponible cuando la conexi√≥n est√© funcionando', 'success');
    });

    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      cargarConfiguracion();
      establecerFechasPorDefecto();
      mostrarMensaje('üëã Configura la URL y haz clic en "Probar Conexi√≥n"', 'success');
    });
  </script>
</body>
</html>
